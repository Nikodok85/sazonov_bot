import os
import telebot
from flask import Flask, request

TOKEN = os.environ.get("BOT_TOKEN")  # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å —Ç–æ–∫–µ–Ω–æ–º
CHANNEL_ID = "@gynekolog_Sazonov"    # –ö–∞–Ω–∞–ª, –∫—É–¥–∞ –±—É–¥—É—Ç —É—Ö–æ–¥–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã

bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# –ö–æ–º–∞–Ω–¥–∞ /start: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫–Ω–æ–ø–∫–∞
@bot.message_handler(commands=['start'])
def send_welcome(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    btn = telebot.types.KeyboardButton("üü¢ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")
    markup.add(btn)

    welcome_text = (
        "üëã –ü—Ä–∏–≤–µ—Ç!\n\n"
        "–¢—ã –º–æ–∂–µ—à—å –∞–Ω–æ–Ω–∏–º–Ω–æ –∑–∞–¥–∞—Ç—å –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ –∞–∫—É—à–µ—Ä—Å—Ç–≤—É –∏ –≥–∏–Ω–µ–∫–æ–ª–æ–≥–∏–∏.\n"
        "–ù–∏–∫–∞–∫–∏—Ö –∏–º—ë–Ω, –Ω–∏–∫–∞–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ —Ç—ã –∏ –º–æ–π –æ—Ç–≤–µ—Ç –≤ –∫–∞–Ω–∞–ª–µ.\n\n"
        "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å:"
    )
    bot.send_message(message.chat.id, welcome_text, reply_markup=markup)

# –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å"
@bot.message_handler(func=lambda message: message.text == "üü¢ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")
def handle_question_prompt(message):
    bot.send_message(message.chat.id, "‚úçÔ∏è –ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å: —è –ø–æ–ª—É—á—É –µ–≥–æ –∞–Ω–æ–Ω–∏–º–Ω–æ –∏ –æ—Ç–≤–µ—á—É –≤ –∫–∞–Ω–∞–ª–µ.")

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –≤ –∫–∞–Ω–∞–ª
@bot.message_handler(func=lambda message: True, content_types=['text'])
def forward_to_channel(message):
    if message.text != "üü¢ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å":
        bot.send_message(CHANNEL_ID, f"‚ùì –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤–æ–ø—Ä–æ—Å:\n\n{message.text}")
        bot.send_message(message.chat.id, "‚úÖ –í–æ–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω! –Ø –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—á—É –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ.")

# Flask endpoint
@app.route("/" + TOKEN, methods=['POST'])
def webhook():
    json_str = request.get_data().decode("UTF-8")
    update = telebot.types.Update.de_json(json_str)
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def root():
    return "Bot is working", 200

if __name__ == "__main__":
    app.run()
